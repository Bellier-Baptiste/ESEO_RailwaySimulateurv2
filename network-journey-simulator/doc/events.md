# PFE METRO SIMULATOR

## Simulator Events

### Introduction

In the simulator, we have different types of events related to the "run" part : 
- TrainEvents : these events are generated by the simulator, and describe when a train arrive in a station
- StationClosed : these events are created in the map_config.xml file, and describe when a specific station is closed.
- LineDelay : these events are created in the map_config.xml file, and describe when the segment between two stations has a delay.

#### WARNING: When configuring the metro network and events in the Java GUI, set the scale to a city and not a continent.
## Event types
### TrainEvents

A trainEvent symbolizes the moment a train arrive in a station. 

During this event, passengers are exchanged between the train and the station (train-> station then station->train). 

TrainEvents are generated by the simulator (in the function simulator.NextEventsTrain ).

### StationClosed

A StationClosed event symbolizes the moment a station is closed to the public.
While closed, trains can still use the lines going through this station, however no passengers should go in or out the station or be left inside during the entirety of the event.

StationClosed events are declared in map_config.xml files and need multiples parameters to be valid (see map_config_schema.xsd to have the detail):
- idStation : the ID of the closed station, as declared in the same file. Note the simulator may have unexpected behavior if the ID does not correspond to any station.
- start : start date of the event. Format should be `2006-01-02T15:04:05Z`
- end : end date of the event. Format should be `2006-01-02T15:04:05Z`

### LineDelay

A LineDelay event symbolizes the moment a segment between two station has a delay. Trains on this segment take more time to do the trip between the station, no matter which line they are on.

Note that in the case of a line A<->B<->C, if the delay is declared between A and C then the trains of this line will not be impacted = Only direct transit will be delayed.

LineDelay events are declared in map_config.xml files and need multiples parameters to be valid (see map_config_schema.xsd to have the detail):
- stationIdStart : the ID of one of the stations, as declared in the same file. IdStart and IdEnd can be permuted.
- stationIdEnd : the ID of the other station, as declared in the same file. IdStart and IdEnd can be permuted.
- delay : the delay in seconds.
- start : start date of the event. Format should be `2006-01-02T15:04:05Z`
- end : end date of the event. Format should be `2006-01-02T15:04:05Z`

the delay is present for stationIdStart->stationIdEnd and stationIdEnd->stationIdStart.

### LineClosed
A LineClosed event is the moment when a line (or e segment of a line) is closed. Trains on this segment stop working and passengers on the segment go out trains of the line.

LineClosed events are declared in map_config.xml files and need multiples parameters to be valid (see map_config_schema.xsd to have the detail):
- stationIdStart : the ID of one of the stations, as declared in the same file. IdStart and IdEnd can be permuted.
- stationIdEnd : the ID of the other station, as declared in the same file. IdStart and IdEnd can be permuted.
- start : start date of the event. Format should be `2006-01-02T15:04:05Z`
- end : end date of the event. Format should be `2006-01-02T15:04:05Z`

## Events Handling

The different events are all called in the function simulator.RunOnce, in this order : 
- StationClosed
- LineDelay
- TrainEvents

### StationClosed handling

StationClosed events are specifically handled in the function simulator.executeEventsStationClosed.
The function is called at the start and at the end of the event.

At the start, all passengers are verified to modify their path if they need to use the station during the interval.
- passengers in the closed station are expulsed and go to the nearest station (according to their path) to reenter the network if they need to travel a lot more.
- passengers in others stations and trains are simply rerouted to the station before the closed station
- passengers outside are rerouted to avoid this station.

Some trips may be removed as passengers do not feel the need to take them as the station closed was part of a little trip.

### LineDelay handling
LineDelay events are specifically handled in the function simulator.executeEventsLineDelay.
The event is called at the start and at the end of the event.

At the start, all trains on the segment are delayed in function of their progression on the segment.
During the event, all trains will be delayed for the value of `delay`
After the event, all trains on the segments are un-delayed in function of their progression on the segment.


### TrainEvents handling
TrainEvents events are handled in the simulator.RunOnce function.

These events do not have any model as they are directly incorporated in the MetroTrain model, using the variables currentStation and timeArrivalCurrentStation.

The events are collected if the train arrives in the station between the last and the current tick (=simulator time) of the simulator. The current tick is determined by the very next TrainEvent.timeArrivalNextStation to happen, to which is added a fixed value ( here it is the timeInStation) to allow the simulator to handle more events concurrently.

The passengers are modified in the following order : 
- outside->stations
- stations->outside
- for each trainEvent : 
    - train->station
    - station->train